{"version":3,"sources":["../../src/commands/build-html.js"],"names":["webpack","require","fs","debug","webpackConfig","store","createErrorFromString","renderHTML","module","exports","program","directory","pages","getState","map","page","path","compilerConfig","Promise","resolve","reject","run","e","stats","outputFile","hasErrors","webpackErrors","toJson","errors","filter","Boolean","length","Error","toString","then","unlinkSync","catch","stack"],"mappings":";;;;;;AACA,MAAMA,UAAUC,QAAS,SAAT,CAAhB;;AACA,MAAMC,KAAKD,QAAS,IAAT,CAAX;;AACA,MAAME,QAAQF,QAAS,OAAT,EAAkB,aAAlB,CAAd;;AAEA,MAAMG,gBAAgBH,QAAS,yBAAT,CAAtB;;iBACkBA,QAAS,UAAT,C;MAAVI,K,YAAAA,K;;kBAC0BJ,QAAS,gCAAT,C;MAA1BK,qB,aAAAA,qB;;AACR,MAAMC,aAAaN,QAAS,wBAAT,CAAnB;;AAEAO,OAAOC,OAAP;AAAA;AAAA;AAAA,6CAAiB,WAAOC,OAAP,EAAwB;AAAA,UAC/BC,SAD+B,GACjBD,OADiB,CAC/BC,SAD+B;AAGvCR,UAAO,wBAAP,EAHuC,CAIvC;;AACA,UAAMS,QAAQP,MAAMQ,QAAN,GAAiBD,KAAjB,CAAuBE,GAAvB,CAA2BC,QAAQA,KAAKC,IAAxC,CAAd,CALuC,CAOvC;;AACA,UAAMC,uBAAuBb,cAC3BM,OAD2B,EAE3BC,SAF2B,EAG1B,YAH0B,EAI3B,IAJ2B,CAA7B;AAOA,WAAO,IAAIO,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtCpB,cAAQiB,cAAR,EAAwBI,GAAxB,CAA4B,CAACC,CAAD,EAAIC,KAAJ,KAAc;AACxC,YAAID,CAAJ,EAAO;AACL,iBAAOF,OAAOE,CAAP,CAAP;AACD;;AACD,cAAME,aAAc,GAAEb,SAAU,wBAAhC;;AACA,YAAIY,MAAME,SAAN,EAAJ,EAAuB;AACrB,cAAIC,gBAAgBH,MAAMI,MAAN,GAAeC,MAAf,CAAsBC,MAAtB,CAA6BC,OAA7B,CAApB;AACA,iBAAOV,OACLM,cAAcK,MAAd,GACIzB,sBAAsBoB,cAAc,CAAd,CAAtB,EAAyC,GAAEF,UAAW,MAAtD,CADJ,GAEI,IAAIQ,KAAJ,CACG,8CAAD,GACG,OAAMT,MAAMU,QAAN,EAAiB,EAF5B,CAHC,CAAP;AAQD;;AAED,eAAO1B,WAAWN,QAAQuB,UAAR,CAAX,EAAgCZ,KAAhC,EACJsB,IADI,CACC,MAAM;AACV;AACA,cAAI;AACFhC,eAAGiC,UAAH,CAAcX,UAAd;AACAtB,eAAGiC,UAAH,CAAe,GAAEX,UAAW,MAA5B;AACD,WAHD,CAGE,OAAOF,CAAP,EAAU,CACV;AACD;;AACD,iBAAOH,QAAQ,IAAR,EAAcI,KAAd,CAAP;AACD,SAVI,EAWJa,KAXI,CAWEd,KAAK;AACVF,iBAAOd,sBAAsBgB,EAAEe,KAAxB,EAAgC,GAAEb,UAAW,MAA7C,CAAP;AACD,SAbI,CAAP;AAcD,OA/BD;AAgCD,KAjCM,CAAP;AAkCD,GAjDD;;AAAA;AAAA;AAAA;AAAA","sourcesContent":["/* @flow */\nconst webpack = require(`webpack`)\nconst fs = require(`fs`)\nconst debug = require(`debug`)(`gatsby:html`)\n\nconst webpackConfig = require(`../utils/webpack.config`)\nconst { store } = require(`../redux`)\nconst { createErrorFromString } = require(`gatsby-cli/lib/reporter/errors`)\nconst renderHTML = require(`../utils/html-renderer`)\n\nmodule.exports = async (program: any) => {\n  const { directory } = program\n\n  debug(`generating static HTML`)\n  // Reduce pages objects to an array of paths.\n  const pages = store.getState().pages.map(page => page.path)\n\n  // Static site generation.\n  const compilerConfig = await webpackConfig(\n    program,\n    directory,\n    `build-html`,\n    null\n  )\n\n  return new Promise((resolve, reject) => {\n    webpack(compilerConfig).run((e, stats) => {\n      if (e) {\n        return reject(e)\n      }\n      const outputFile = `${directory}/public/render-page.js`\n      if (stats.hasErrors()) {\n        let webpackErrors = stats.toJson().errors.filter(Boolean)\n        return reject(\n          webpackErrors.length\n            ? createErrorFromString(webpackErrors[0], `${outputFile}.map`)\n            : new Error(\n                `There was an issue while building the site: ` +\n                  `\\n\\n${stats.toString()}`\n              )\n        )\n      }\n\n      return renderHTML(require(outputFile), pages)\n        .then(() => {\n          // Remove the temp JS bundle file built for the static-site-generator-plugin\n          try {\n            fs.unlinkSync(outputFile)\n            fs.unlinkSync(`${outputFile}.map`)\n          } catch (e) {\n            // This function will fail on Windows with no further consequences.\n          }\n          return resolve(null, stats)\n        })\n        .catch(e => {\n          reject(createErrorFromString(e.stack, `${outputFile}.map`))\n        })\n    })\n  })\n}\n"],"file":"build-html.js"}